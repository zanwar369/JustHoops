<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rec League Stats Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .data-cell {
            padding: 1rem 1.5rem;
            white-space: nowrap;
            font-size: 0.875rem;
            color: #374151; /* gray-700 */
        }
        .header-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .header-cell:hover {
            background-color: #3730a3; /* indigo-700 */
        }
        .tab-active {
            border-bottom-width: 3px;
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <div class="max-w-7xl mx-auto p-4 sm:p-8">

        <!-- Header -->
        <header class="py-6 border-b border-indigo-300 mb-6">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 mr-3 text-indigo-600">
                    <path fill-rule="evenodd" d="M11.54 22.351A2.25 2.25 0 0 0 14.15 22.5h2.25a2.25 2.25 0 0 0 2.602-1.78l.842-4.212A2.25 2.25 0 0 0 17.5 14.25h-4.75a.75.75 0 0 1-.75-.75V8.526a4.5 4.5 0 0 0 3.75-4.493V3a.75.75 0 0 0-.75-.75h-8.25A.75.75 0 0 0 6 3v.033a4.5 4.5 0 0 0 3.75 4.493v5.478a.75.75 0 0 1-.75.75H4.25a2.25 2.25 0 0 0-2.602 2.756l.842 4.212A2.25 2.25 0 0 0 4.85 22.5h2.25a2.25 2.25 0 0 0 2.602-1.78l.108-.54h.878l.108.54Z" clip-rule="evenodd" />
                </svg>
                Rec League Stats
            </h1>
            <p class="text-gray-500 text-lg" id="subTitle">
                Winter 2025 Season Overview.
            </p>
        </header>
        
        <!-- Navigation Tabs -->
        <div class="flex border-b border-gray-200 mb-6">
            <button onclick="setTabView('standings')" id="tab-standings" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-indigo-600 transition">
                Standings
            </button>
            <button onclick="setTabView('stats')" id="tab-stats" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-indigo-600 transition tab-active">
                Player Stats
            </button>
        </div>

        <!-- Controls (Filtering) -->
        <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-white rounded-xl shadow-md ring-1 ring-gray-100">
            <div class="flex-grow">
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Filter by Player or Team Name..."
                    class="w-full pl-4 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                    oninput="filterTable()"
                />
            </div>

            <!-- Season Selector -->
            <select id="seasonSelector" onchange="filterData()" class="p-2 border border-gray-300 rounded-lg shadow-sm">
                <!-- Options populated by JS -->
            </select>
            
            <!-- Division Selector (only visible on Standings tab) -->
            <select id="divisionSelector" onchange="filterData()" class="p-2 border border-gray-300 rounded-lg shadow-sm hidden">
                <!-- Options populated by JS -->
            </select>

            <!-- Week Selector (only visible on Standings tab) -->
            <select id="weekSelector" onchange="filterData()" class="p-2 border border-gray-300 rounded-lg shadow-sm hidden">
                <!-- Options populated by JS -->
            </select>
            
            <div id="dataStatus" class="bg-indigo-100 text-indigo-700 p-2 rounded-lg text-sm font-medium shrink-0">
                Loading data...
            </div>
        </div>

        <!-- Dynamic Content Area -->
        <div id="contentArea">
            <!-- Summary Stat Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="summaryCards">
                <!-- Stat Cards will be rendered here -->
            </div>
            
            <!-- Main Display (Standings Table / Player Table) -->
            <div class="bg-white rounded-xl shadow-2xl overflow-x-auto ring-1 ring-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-600 text-white">
                        <tr id="statsTableHead">
                            <!-- Headers will be generated by JS -->
                        </tr>
                    </thead>
                    <tbody id="statsTableBody" class="divide-y divide-gray-100">
                        <!-- Player or Standings rows will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION & COMPLEX MOCK DATA ---
        // NOTE: In a real app, this data would be fetched from a single, consolidated JSON file
        // generated by a script that processed all your weekly Excel sheets.

        // This list defines ALL STATS from your Excel files that should be processed.
        const STAT_COLUMNS = [
            { key: 'name', label: 'Player', isNumeric: false },
            { key: 'team', label: 'Team', isNumeric: false },
            { key: 'division', label: 'Division', isNumeric: false },
            { key: 'totalpoints', label: 'PTS', isNumeric: true, decimal: 1 },
            { key: 'ftm', label: 'FTM', isNumeric: true, decimal: 0 },
            { key: 'fta', label: 'FTA', isNumeric: true, decimal: 0 },
            { key: 'ft_percent', label: 'FT%', isNumeric: true, isPercent: true },
            { key: '2pm', label: '2PM', isNumeric: true, decimal: 0 },
            { key: '2pa', label: '2PA', isNumeric: true, decimal: 0 },
            { key: '2p_percent', label: '2P%', isNumeric: true, isPercent: true },
            { key: '3pm', label: '3PM', isNumeric: true, decimal: 0 },
            { key: '3pa', label: '3PA', isNumeric: true, decimal: 0 },
            { key: '3p_percent', label: '3P%', isNumeric: true, isPercent: true },
            { key: 'fg_percent', label: 'FG%', isNumeric: true, isPercent: true },
            { key: 'rebounds', label: 'REB', isNumeric: true, decimal: 1 },
            { key: 'assists', label: 'AST', isNumeric: true, decimal: 1 },
            { key: 'blocks', label: 'BLK', isNumeric: true, decimal: 1 },
            { key: 'steals', label: 'STL', isNumeric: true, decimal: 1 },
            { key: 'turnovers', label: 'TO', isNumeric: true, decimal: 1 },
            { key: 'fouls', label: 'PF', isNumeric: true, decimal: 1 },
            { key: 'games_played', label: 'GP', isNumeric: true, decimal: 0 }, // Calculated
        ];
        
        // This simulates your full, processed JSON data.
        const LEAGUE_DATA = {
            "Winter 2025": {
                // Game logs are structured for Standings calculation
                "gameLogs": [
                    // Week 1
                    { week: 1, team: "Blue Bombers", div: "D2", score: 65, oppScore: 60, opp: "Green Giants" },
                    { week: 1, team: "Green Giants", div: "D2", score: 60, oppScore: 65, opp: "Blue Bombers" },
                    { week: 1, team: "Red Rockets", div: "D3", score: 45, oppScore: 48, opp: "White Wolves" },
                    { week: 1, team: "White Wolves", div: "D3", score: 48, oppScore: 45, opp: "Red Rockets" },
                    // Week 2
                    { week: 2, team: "Blue Bombers", div: "D2", score: 70, oppScore: 72, opp: "Black Hawks" },
                    { week: 2, team: "Black Hawks", div: "D2", score: 72, oppScore: 70, opp: "Blue Bombers" },
                    { week: 2, team: "Green Giants", div: "D2", score: 55, oppScore: 50, opp: "Yellow Jackets" },
                    { week: 2, team: "Yellow Jackets", div: "D2", score: 50, oppScore: 55, opp: "Green Giants" },
                ],
                // Player stats should be pre-aggregated (Averaged) by your Python script
                "playerStats": [
                    { name: 'Alex Jones', team: 'Blue Bombers', division: 'D2', totalpoints: 25.4, rebounds: 6.2, assists: 4.8, fg_percent: 0.512, games_played: 2, ftm: 3, fta: 4, ft_percent: 0.75, '2pm': 10, '2pa': 20, '2p_percent': 0.5, '3pm': 5, '3pa': 10, '3p_percent': 0.5, blocks: 0.5, steals: 1.5, turnovers: 2.0, fouls: 2.0 },
                    { name: 'Chris Baker', team: 'Blue Bombers', division: 'D2', totalpoints: 14.7, rebounds: 3.9, assists: 7.2, fg_percent: 0.435, games_played: 2, ftm: 2, fta: 2, ft_percent: 1.0, '2pm': 6, '2pa': 15, '2p_percent': 0.4, '3pm': 0, '3pa': 3, '3p_percent': 0.0, blocks: 0.0, steals: 0.5, turnovers: 3.0, fouls: 1.0 },
                    { name: 'Brandon Smith', team: 'Green Giants', division: 'D2', totalpoints: 19.1, rebounds: 10.5, assists: 3.1, fg_percent: 0.488, games_played: 2, ftm: 4, fta: 6, ft_percent: 0.667, '2pm': 8, '2pa': 15, '2p_percent': 0.533, '3pm': 1, '3pa': 5, '3p_percent': 0.2, blocks: 1.0, steals: 2.0, turnovers: 1.0, fouls: 3.0 },
                    { name: 'Black Player 1', team: 'Black Hawks', division: 'D2', totalpoints: 20.0, rebounds: 8.0, assists: 5.0, fg_percent: 0.500, games_played: 1, ftm: 2, fta: 3, ft_percent: 0.667, '2pm': 8, '2pa': 16, '2p_percent': 0.5, '3pm': 0, '3pa': 0, '3p_percent': 0.0, blocks: 0.0, steals: 1.0, turnovers: 1.0, fouls: 1.0 },
                    // ... More players for D2, D3, D4, D5
                ]
            }
        };

        // --- GLOBAL STATE ---
        let currentTabView = 'stats'; // 'stats' or 'standings'
        let currentSeason = 'Winter 2025';
        let currentDivision = 'D2';
        let currentWeek = 2; // Default to max week
        let players = [];
        let teams = [];
        let sortConfig = { key: 'totalpoints', direction: 'desc' };
        
        // --- DATA PROCESSING & CALCULATIONS ---

        function calculateStandings(week) {
            const gameLogs = LEAGUE_DATA[currentSeason].gameLogs.filter(log => log.week <= week);
            const standingsMap = {};

            gameLogs.forEach(log => {
                if (!standingsMap[log.team]) {
                    standingsMap[log.team] = {
                        team: log.team,
                        division: log.div,
                        wins: 0,
                        losses: 0,
                        pointsScored: 0,
                        pointsAllowed: 0,
                    };
                }

                const teamStats = standingsMap[log.team];
                
                // Update W/L
                if (log.score > log.oppScore) {
                    teamStats.wins += 1;
                } else {
                    teamStats.losses += 1;
                }
                
                // Update Points
                teamStats.pointsScored += log.score;
                teamStats.pointsAllowed += log.oppScore;
            });
            
            // Convert to array and calculate Point Differential
            let standingsArray = Object.values(standingsMap).map(stats => ({
                ...stats,
                pointDifferential: stats.pointsScored - stats.pointsAllowed,
                gamesPlayed: stats.wins + stats.losses,
            }));

            // Sort: 1. By Division, 2. By Win/Loss Ratio, 3. By Point Differential
            standingsArray.sort((a, b) => {
                if (a.division < b.division) return -1;
                if (a.division > b.division) return 1;

                const winRatioA = a.wins / a.gamesPlayed;
                const winRatioB = b.wins / b.gamesPlayed;
                if (winRatioA !== winRatioB) {
                    return winRatioB - winRatioA; // Higher ratio comes first
                }
                return b.pointDifferential - a.pointDifferential; // Higher differential comes first
            });

            return standingsArray.filter(s => s.division === currentDivision);
        }

        // Filters players by the currently selected division
        function getFilteredPlayers() {
            return players.filter(p => p.division === currentDivision);
        }

        // --- UI MANIPULATION ---

        function setTabView(view) {
            currentTabView = view;
            const tabs = ['stats', 'standings'];
            tabs.forEach(tab => {
                document.getElementById(`tab-${tab}`).classList.remove('tab-active');
            });
            document.getElementById(`tab-${view}`).classList.add('tab-active');

            // Toggle visibility of Division/Week selectors
            const isStandings = view === 'standings';
            document.getElementById('divisionSelector').classList.toggle('hidden', !isStandings);
            document.getElementById('weekSelector').classList.toggle('hidden', !isStandings);

            if (isStandings) {
                 document.getElementById('searchInput').placeholder = 'Filter Standings by Team...';
            } else {
                 document.getElementById('searchInput').placeholder = 'Filter Player Stats by Player or Team Name...';
            }
            
            filterData(); // Re-render content
        }
        
        function filterData() {
            // Update global state from selectors
            currentSeason = document.getElementById('seasonSelector').value;
            currentDivision = document.getElementById('divisionSelector').value;
            currentWeek = parseInt(document.getElementById('weekSelector').value);

            // Update page title
            document.getElementById('subTitle').textContent = `${currentSeason} Season - ${currentDivision} | Up to Week ${currentWeek}`;
            
            // Re-render the active view
            if (currentTabView === 'standings') {
                renderStandingsPage();
            } else {
                renderStatsPage();
            }
        }
        
        // --- RENDERING VIEWS ---

        // Renders the summary cards (League Averages)
        function renderSummaryCards(data) {
            const cardContainer = document.getElementById('summaryCards');
            if (data.length === 0) {
                cardContainer.innerHTML = '';
                return;
            }
            
            const totalPlayers = data.length;
            const totalPoints = data.reduce((sum, p) => sum + p.totalpoints, 0);
            const totalRebounds = data.reduce((sum, p) => sum + p.rebounds, 0);
            const totalAssists = data.reduce((sum, p) => sum + p.assists, 0);

            const avgPts = (totalPoints / totalPlayers).toFixed(1);
            const avgReb = (totalRebounds / totalPlayers).toFixed(1);
            const avgAst = (totalAssists / totalPlayers).toFixed(1);
            const totalTeams = new Set(data.map(p => p.team)).size;
            
            cardContainer.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow-lg border-b-4 border-indigo-500">
                    <p class="text-sm font-medium text-gray-500 uppercase">League Avg. PTS</p>
                    <p class="mt-1 text-3xl font-extrabold text-gray-900">${avgPts}</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border-b-4 border-indigo-500">
                    <p class="text-sm font-medium text-gray-500 uppercase">Total Teams (${currentDivision})</p>
                    <p class="mt-1 text-3xl font-extrabold text-gray-900">${totalTeams}</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border-b-4 border-indigo-500">
                    <p class="text-sm font-medium text-gray-500 uppercase">League Avg. REB</p>
                    <p class="mt-1 text-3xl font-extrabold text-gray-900">${avgReb}</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border-b-4 border-indigo-500">
                    <p class="text-sm font-medium text-gray-500 uppercase">League Avg. AST</p>
                    <p class="mt-1 text-3xl font-extrabold text-gray-900">${avgAst}</p>
                </div>
            `;
        }

        function renderStatsPage() {
            const filteredPlayers = getFilteredPlayers();
            renderSummaryCards(filteredPlayers);
            renderHeaders('stats');
            renderPlayerTable(filteredPlayers);
        }

        function renderStandingsPage() {
            const standings = calculateStandings(currentWeek);
            renderSummaryCards([]); // Hide player cards on standings page initially
            renderStandingsHeaders();
            renderStandingsTable(standings);
        }

        // Renders table headers based on the current view
        function renderHeaders(viewType) {
            const headRow = document.getElementById('statsTableHead');
            headRow.innerHTML = '';
            
            const columnsToDisplay = STAT_COLUMNS.filter((_, i) => i < 11); // Show only the first 11 columns for the main stats page prototype.
            
            columnsToDisplay.forEach(col => {
                const th = document.createElement('th');
                th.className = 'header-cell px-6 py-3 text-left text-xs font-bold uppercase tracking-wider transition';
                th.onclick = () => sortPlayers(col.key);

                let icon = '';
                if (sortConfig.key === col.key) {
                    icon = sortConfig.direction === 'asc'
                        ? '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>'
                        : '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>';
                }

                th.innerHTML = `<div class="flex items-center">
                                    ${col.label}
                                    ${icon}
                                </div>`;
                headRow.appendChild(th);
            });
        }
        
        // Renders specific headers for the Standings view
        function renderStandingsHeaders() {
            const headRow = document.getElementById('statsTableHead');
            headRow.innerHTML = `
                <th class="header-cell px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Rank</th>
                <th class="header-cell px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Team</th>
                <th class="header-cell px-6 py-3 text-center text-xs font-bold uppercase tracking-wider">W</th>
                <th class="header-cell px-6 py-3 text-center text-xs font-bold uppercase tracking-wider">L</th>
                <th class="header-cell px-6 py-3 text-center text-xs font-bold uppercase tracking-wider">P. Scored</th>
                <th class="header-cell px-6 py-3 text-center text-xs font-bold uppercase tracking-wider">P. Allowed</th>
                <th class="header-cell px-6 py-3 text-center text-xs font-bold uppercase tracking-wider">Point Diff</th>
            `;
        }
        
        function renderPlayerTable(playersData) {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            const filteredPlayers = playersData.filter(player => {
                const nameMatch = player.name.toLowerCase().includes(searchTerm);
                const teamMatch = player.team ? player.team.toLowerCase().includes(searchTerm) : false;
                return nameMatch || teamMatch;
            });

            if (filteredPlayers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${STAT_COLUMNS.length}" class="px-6 py-12 text-center text-gray-500 text-lg">No players found in ${currentDivision} matching the criteria.</td></tr>`;
                return;
            }

            // Sort the data before rendering
            filteredPlayers.sort((a, b) => {
                const key = sortConfig.key;
                const aVal = a[key] || 0;
                const bVal = b[key] || 0;
                
                const colDef = STAT_COLUMNS.find(c => c.key === key);
                const isNumeric = colDef && colDef.isNumeric;
                
                if (isNumeric) {
                    return sortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
                } else {
                    const comparison = aVal.toString().localeCompare(bVal.toString());
                    return sortConfig.direction === 'asc' ? comparison : -comparison;
                }
            });

            filteredPlayers.forEach(player => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-indigo-50 transition';

                STAT_COLUMNS.filter((_, i) => i < 11).forEach(col => {
                    const cell = row.insertCell();
                    cell.className = 'data-cell';
                    let displayValue = player[col.key] !== undefined ? player[col.key] : 'N/A';

                    if (col.key === 'name') {
                        // Special handling for Player/Team cell
                        const teamName = player.team || 'N/A';
                        cell.innerHTML = `<div class="font-semibold text-gray-900">${player.name}</div>
                                          <div class="text-xs text-indigo-500">${teamName}</div>`;
                    } else if (col.isPercent) {
                        displayValue = (parseFloat(displayValue) * 100).toFixed(1) + '%';
                        cell.classList.add('font-mono', 'text-green-600');
                    } else if (col.isNumeric) {
                        displayValue = parseFloat(displayValue).toFixed(col.decimal);
                        cell.classList.add('font-semibold');
                    }

                    if (col.key !== 'name') {
                        cell.textContent = displayValue;
                    }
                });
            });
        }
        
        function renderStandingsTable(standingsData) {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            const filteredStandings = standingsData.filter(s => s.team.toLowerCase().includes(searchTerm));

            if (filteredStandings.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500 text-lg">No standings data for ${currentDivision} up to Week ${currentWeek}.</td></tr>`;
                return;
            }

            filteredStandings.forEach((s, index) => {
                const rank = index + 1;
                const row = tbody.insertRow();
                row.className = 'hover:bg-indigo-50 transition';
                
                const diffColor = s.pointDifferential > 0 ? 'text-green-600 font-bold' : (s.pointDifferential < 0 ? 'text-red-600' : 'text-gray-700');

                row.innerHTML = `
                    <td class="data-cell text-center font-extrabold text-lg text-indigo-700">${rank}</td>
                    <td class="data-cell font-semibold text-gray-900">${s.team}</td>
                    <td class="data-cell text-center">${s.wins}</td>
                    <td class="data-cell text-center">${s.losses}</td>
                    <td class="data-cell text-center">${s.pointsScored}</td>
                    <td class="data-cell text-center">${s.pointsAllowed}</td>
                    <td class="data-cell text-center ${diffColor}">${s.pointDifferential > 0 ? '+' : ''}${s.pointDifferential}</td>
                `;
            });
        }


        // --- INITIALIZATION ---
        function populateSelectors() {
            const seasonSel = document.getElementById('seasonSelector');
            const divisionSel = document.getElementById('divisionSelector');
            const weekSel = document.getElementById('weekSelector');

            // Seasons
            Object.keys(LEAGUE_DATA).forEach(season => {
                seasonSel.options.add(new Option(season, season, true, season === currentSeason));
            });

            // Divisions (based on current data)
            const divisions = new Set(LEAGUE_DATA[currentSeason].gameLogs.map(l => l.div));
            divisions.forEach(div => {
                divisionSel.options.add(new Option(div, div, true, div === currentDivision));
            });
            
            // Weeks (based on current data)
            const maxWeek = LEAGUE_DATA[currentSeason].gameLogs.reduce((max, log) => Math.max(max, log.week), 1);
            for (let i = 1; i <= maxWeek; i++) {
                 weekSel.options.add(new Option(`Week ${i}`, i, true, i === maxWeek));
            }
            
            // Set initial state
            players = LEAGUE_DATA[currentSeason].playerStats;
            currentWeek = maxWeek;
            currentDivision = divisions.values().next().value; // Set to the first division found
        }
        
        async function init() {
            document.getElementById('dataStatus').textContent = 'Data Loaded (Simulated)';

            populateSelectors();
            setTabView('standings'); // Start on the Standings page as requested
        }
        
        window.onload = init;
    </script>
</body>
</html>